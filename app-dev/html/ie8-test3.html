<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <title>IE8 Compositor Filter</title>
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=3.0, user-scalable=1">
    <link rel="stylesheet" href="../styles/base/base.min.css">
    <link rel="stylesheet" href="../styles/base/theme-base.min.css">
    <script src="../scripts/vendors/jquery-1.12.4.min.js"></script>
    <style type="text/css">
        body { 
            padding: 30px 0;
            background: #666;
            text-align: center;
        }

        .page {
            width: 600px;
            margin: auto;
        }

        #user-info-bar-user-avatar {
            box-sizing: border-box;
            position: relative;
            width: 84px;
            height: 84px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: 100%;
            background-size: cover;
            border-radius: 1000px;
            overflow: hidden;

            -ms-filter: "progid:DXImageTransform.Microsoft.Compositor(function=21)";
                filter:  progid:DXImageTransform.Microsoft.Compositor(function=21);
        }

        .ie-compositor-mask {
            font-family: 'iconfont'!important;
            position: absolute;
            left: 0;
            top: -8px;
            text-indent: 0;
            font-size: 84px;
            line-height: 90px;
            text-align: center;
            color: lightgreen;
        }
        .ie-image {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            margin: auto;
            width: 84px;
            height: 84px;
            background-color: white;
            overflow: hidden;
        }
        #user-info-bar-user-avatar img {
            position: absolute;
            left: 0;
            top: 0;
        }
    </style>
</head>
<body>
<div class="page">
    <div id="user-info-bar-user-avatar" style="">
        <div class="ie-compositor-mask">&#xe68c;</div>
        <div class="ie-image"><img></div>
    </div>
</div>

<script type="text/javascript">
    (function () {
        var avatar = document.getElementById('user-info-bar-user-avatar');
        var avatarMask = $(avatar).find('.ie-compositor-mask')[0];
        var imgParent = $(avatar).find('.ie-image')[0];
        var img = $(avatar).find('img')[0];

        var filterCompositor;
        if (avatar && avatar.filters) {
            try {
                filterCompositor = avatar.filters.item('DXImageTransform.Microsoft.Compositor');
            } catch(e) {
            }
        }

        setTimeout(function () {
            applyAvatarUri('../images/_temp/fake-avatar-2.jpg');
        }, 0);

        setTimeout(function () {
            applyAvatarUri('../images/_temp/fake-avatar-1.png');
        }, 4000);




        function applyAvatarUri(imageUri) {
            if (!avatar) return false;

            if (!filterCompositor || !avatarMask || !imgParent || !img) {
                avatar.style.backgroundImage = 'url('+imageUri+')';

                if (avatarMask) avatarMask.style.display = 'none';
                if (imgParent) imgParent.style.display = 'none';

                return true;
            }

            if (img.src === imageUri) return true;

            setTimeout(function () {
                img.style.width  = '';
                img.style.height = '';
                img.style.top  = '';
                img.style.left = '';

                img.src = imageUri;
            }, 0);

            img.onload = function (event) {
                var imgDimesion = getImageNaturalDimention(img);
                console.log('img dim: ', imgDimesion.naturalWidth, imgDimesion.naturalHeight);
                var isLandscape = imgDimesion.naturalWidth >= imgDimesion.naturalHeight;


                var targetLength = $(avatar).width();
                var targetW = targetLength;
                var targetH = targetLength;

                console.log('targetLength: ', targetLength);

                if (isLandscape) {
                    targetW = targetH * imgDimesion.naturalWidth / imgDimesion.naturalHeight;
                    img.style.left = (targetW - targetLength) * -0.5 + 'px';
                    img.style.top  = '0';
                } else {
                    targetH = targetW * imgDimesion.naturalHeight / imgDimesion.naturalWidth;
                    img.style.left = '0';
                    img.style.top  = (targetH - targetLength) * -0.5 + 'px';;
                }

                console.log('img target dim: ', targetW, targetH);
                img.style.width  = targetW + 'px';
                img.style.height = targetH + 'px';

                applyAvatarMaskForOldIE();
            };

            return true;
        }

        function getImageNaturalDimention(img) {
            if (!img) {
                return {
                    naturalWidth: NaN,
                    naturalHeight: NaN
                };
            }

            if (typeof img.naturalWidth === 'number') {
                return {
                    naturalWidth: img.naturalWidth,
                    naturalHeight: img.naturalHeight
                };
            }

            return {
                naturalWidth: $(img).width(),
                naturalHeight: $(img).height()
            };
        }

        function applyAvatarMaskForOldIE(imageUri) {
            // if (!avatarMask || !imgParent || !filter) return false;

            avatarMask.style.display = 'block';
            imgParent.style.display = 'none';
            filterCompositor.Apply();

            avatarMask.style.display = 'none';
            imgParent.style.display = 'block';
            filterCompositor.Play();
        }
    })();
</script>
</body>
</html>
