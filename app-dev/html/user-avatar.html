<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	<title>user avatar</title>
	<link rel="stylesheet" href="../styles/base/base.min.css">
    <link rel="stylesheet" href="../styles/pages/xfzq-base.min.css">
	<script src="../scripts/vendors/jquery-1.12.4.min.js"></script>
</head>
<body>
<div id="ie-user-avatar-iframe-bg"><div class="ie-bg" style="display: block;"></div></div>
<div id="ie-user-avatar"></div>
<div id="ie-user-avatar-borders"></div>
<script type="text/javascript">
	$(function () {
        var qString = location.href.match(/\?.*/);
        if (qString) qString = qString[0].slice(1);

        var qKVPairs = [];
        if (qString) {
            qKVPairs = qString.split('&');
        }

        var imageUri;

        for (var i in qKVPairs){
            var kvpString = qKVPairs[i];
            var kvp = kvpString.split('=');

            if (kvp[0] === 'avatarImage') imageUri = kvp[1];
        }



        var thePerfectPercentage = 70;
        var avatar = new AvatarController(document.getElementById('ie-user-avatar'), {
            disableOldIEMask: false
        });


        if (imageUri) {
            avatar.update(imageUri);
        } else {
            console.error(
                'No image uri passed into this iframe page.',
                '\n\tPlease using "avatarImage" as the query part of the iframe src.',
                '\n\ti.e. "<url of this html>?avatarImage=<your avatar image source uri>."'
            );
        }





        function AvatarController(avatar, options) {
            if (!avatar) return undefined;

            options = options || {};

            var filtersEnabled = typeof avatar.filters === 'object' && navigator.userAgent.search(' MSIE 8.0') > 0;
            var oldIEMaskEnabled = !options.disableOldIEMask && filtersEnabled;
            var filterIris, avatarImage;

            // var offsetXPropertyName = 'left'; // doesn't work
            // var offsetYPropertyName = 'top';  // doesn't work

            var offsetXPropertyName = 'marginLeft';
            var offsetYPropertyName = 'marginTop';



            init.call(this);


            this.update = function (imageUri) {
                update.call(this, imageUri);
            }

            function init() {
                avatarImage = $(avatar).find('img')[0];

                if (!filtersEnabled) {
                    // we are going to use background image
                    if (avatarImage) avatarImage.style.display = 'none';

                    return;
                }

                if (!avatarImage) {
                    // console.log('Creating avatarImage...');
                    avatarImage = document.createElement('IMG');
                    avatar.appendChild(avatarImage);
                }

                if (oldIEMaskEnabled) {
                    try {
                        filterIris = avatar.filters.item('DXImageTransform.Microsoft.Iris');
                    } catch(e) {
                        avatar.style.filter = 'progid:DXImageTransform.Microsoft.Iris(IrisStyle=circle, Motion=out)';
                        filterIris = avatar.filters.item('DXImageTransform.Microsoft.Iris');
                    }

                    avatarImage.style.display = 'none';

                    filterIris.Apply();
                    filterIris.Percent = thePerfectPercentage;
                    avatarImage.style.display = '';
                }
            }

            function update(imageUri) {
                if (!filtersEnabled) {
                    avatar.style.backgroundImage = 'url('+imageUri+')';
                    return;
                }

                if (avatarImage.src === imageUri) return;

                avatarImage.style.width  = '';
                avatarImage.style.height = '';
                avatarImage.style[offsetXPropertyName] = '';
                avatarImage.style[offsetYPropertyName] = '';

                avatarImage.onload = function (event) {
                    locateImageInside(avatarImage, avatar);
                };

                avatarImage.src = imageUri;

                return;
            }

            function locateImageInside(img, container) {
                var imgDimesion = getImageNaturalDimention(img);
                var nW = imgDimesion.naturalWidth;
                var nH = imgDimesion.naturalHeight;
                var isLandscape = nW >= nH;

                var tSize = $(container).width(); // target size
                var tW = tSize; // target width
                var tH = tSize; // target height

                var x = 0;
                var y = 0;

                if (isLandscape) {
                    tW = tH * nW / nH;
                    x = (tW - tSize) * -0.5 + 'px';
                    y = '0';
                } else {
                    tH = tW * nH / nW;
                    x = '0';
                    y = (tH - tSize) * -0.5 + 'px';;
                }

                // console.log(
                //     '\nimg dim: ', nW, ' * ', nH,
                //     '\ntarget dim: ', tW, ' * ', tH,
                //     '\noffset: ', 'x = ', x, '; y = ', y,
                //     '\n'
                // );

                img.style.width  = tW + 'px';
                img.style.height = tH + 'px';
                img.style[offsetXPropertyName] = x;
                img.style[offsetYPropertyName] = y;
            }

            function getImageNaturalDimention(img) {
                if (!img) {
                    return {
                        naturalWidth: NaN,
                        naturalHeight: NaN
                    };
                }

                if (typeof img.naturalWidth === 'number') {
                    return {
                        naturalWidth:  img.naturalWidth,
                        naturalHeight: img.naturalHeight
                    };
                }

                return {
                    naturalWidth:  $(img).width(),
                    naturalHeight: $(img).height()
                };
            }
        }
	});
</script>
</body>
</html>