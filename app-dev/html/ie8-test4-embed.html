<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html class="touch-off">
<head>
    <!-- inject:headBeforeTitle:html --><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><!-- endinject -->
    <title>Index</title>
    <!-- inject:headAfterTitle:html --><meta name="viewport" content="initial-scale=1.0, maximum-scale=3.0, user-scalable=1">
<link rel="stylesheet" href="../styles/base/base.min.css">
<link rel="stylesheet" href="../styles/base/theme-base.min.css">
<!--[if lte IE 8]>
<link rel="stylesheet" href="../styles/base/base-ie8.min.css">
<link rel="stylesheet" href="../styles/base/base-ie8-theme.min.css">
<![endif]-->
<script src="../scripts/vendors/jquery-1.12.4.min.js"></script><!-- endinject -->
    <link rel="stylesheet" type="text/css" href="../styles/pages/xfzq-base.min.css">
    <!--[if lte IE 8]>
    <link rel="stylesheet" type="text/css" href="../styles/pages/xfzq-base-ie8.min.css">
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="../styles/pages/xfzq-index.min.css">
</head>
<body>
<!-- inject:xfzqUserInfoBar:html --><div class="row" id="user-info-bar">
    <div class="ie-bg"></div>
    <div class="width-wrap">
        <div class="user-avatar-block">
            <div id="user-info-bar-user-avatar"></div>
        </div>
        <div class="user-info-block"></div>
    </div>
</div><!-- endinject -->
 
<script src="../scripts/pages/xfzq-index.min.js"></script>
<script type="text/javascript">
(function () {
    var avatar = new AvatarController(document.getElementById('user-info-bar-user-avatar'), {
        disableOldIEMask: false
    });
    avatar.update('../images/_temp/fake-avatar-1.png');

    function AvatarController(avatar, options) {
        if (!avatar) return undefined;

        options = options || {};

        var filtersEnabled = typeof avatar.filters === 'object';
        var oldIEMaskEnabled = !options.disableOldIEMask && filtersEnabled;
        var filterIris, avatarImage;

        init.call(this);


        this.update = function (imageUri) {
            update.call(this, imageUri);
        }

        function init() {
            avatarImage = $(avatar).find('img')[0];

            if (!filtersEnabled) {
                // we are going to use background image
                if (avatarImage) avatarImage.style.display = 'none';

                return;
            }

            if (!avatarImage) {
                // console.log('Creating avatarImage...');
                avatarImage = document.createElement('IMG');
                avatar.appendChild(avatarImage);
            }

            if (oldIEMaskEnabled) {
                try {
                    filterIris = avatar.filters.item('DXImageTransform.Microsoft.Iris');
                } catch(e) {
                    avatar.style.filter = 'progid:DXImageTransform.Microsoft.Iris(IrisStyle=circle, Motion=out)';
                    filterIris = avatar.filters.item('DXImageTransform.Microsoft.Iris');
                }

                avatarImage.style.display = 'none';

                filterIris.Apply();
                filterIris.Percent = 71;
                avatarImage.style.display = '';
            }
        }

        function update(imageUri) {
            if (!filtersEnabled) {
                avatar.style.backgroundImage = 'url('+imageUri+')';
                return;
            }

            if (avatarImage.src === imageUri) return;

            avatarImage.style.width  = '';
            avatarImage.style.height = '';
            avatarImage.style.left   = '';
            avatarImage.style.top    = '';

            avatarImage.onload = function (event) {
                locateImageInside(avatarImage, avatar);
            };

            avatarImage.src = imageUri;

            return;
        }

        function locateImageInside(img, container) {
            var imgDimesion = getImageNaturalDimention(img);
            var nW = imgDimesion.naturalWidth;
            var nH = imgDimesion.naturalHeight;
            var isLandscape = nW >= nH;

            var tSize = $(container).width(); // target size
            var tW = tSize; // target width
            var tH = tSize; // target height

            var x = 0;
            var y = 0;

            if (isLandscape) {
                tW = tH * nW / nH;
                x = (tW - tSize) * -0.5 + 'px';
                y = '0';
            } else {
                tH = tW * nH / nW;
                x = '0';
                y = (tH - tSize) * -0.5 + 'px';;
            }

            // console.log(
            //     '\nimg dim: ', nW, ' * ', nH,
            //     '\ntarget dim: ', tW, ' * ', tH,
            //     '\noffset: ', 'x = ', x, '; y = ', y,
            //     '\n'
            // );

            img.style.width  = tW + 'px';
            img.style.height = tH + 'px';
            img.style.left   = x;
            img.style.top    = y;
        }

        function getImageNaturalDimention(img) {
            if (!img) {
                return {
                    naturalWidth: NaN,
                    naturalHeight: NaN
                };
            }

            if (typeof img.naturalWidth === 'number') {
                return {
                    naturalWidth:  img.naturalWidth,
                    naturalHeight: img.naturalHeight
                };
            }

            return {
                naturalWidth:  $(img).width(),
                naturalHeight: $(img).height()
            };
        }
    }
})();
</script>
</body>
</html>
